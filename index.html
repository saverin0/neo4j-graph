<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Graph Explorer</title>

  <!-- Cytoscape -->
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

  <!-- Layout engine -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
    }

    #cy {
      flex: 1;
      background: #ffffff;
    }

    #side {
      width: 330px;
      border-left: 1px solid #ddd;
      padding: 12px;
      overflow-y: auto;
      background: #fafafa;
    }

    #toolbar {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 13px;
    }

    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      margin-right: 6px;
    }

    button:hover {
      background: #eaeaea;
    }

    .prop {
      margin-bottom: 8px;
    }

    .key {
      color: #555;
      font-size: 12px;
    }

    .val {
      font-size: 13px;
      word-break: break-word;
    }
  </style>
</head>

<body>

<div id="toolbar">
  <b>Graph Explorer</b><br>
  Starting view: CircularValueChain · Partner · Deliverable<br>
  <button onclick="resetView()">Home</button>
  <button onclick="showAll()">Show all</button>
</div>

<div id="app">
  <div id="cy"></div>
  <div id="side">
    <h3>Details</h3>
    <div id="details">Click a node to view properties</div>
  </div>
</div>

<script>

// ===== Load Neo4j exported JSON =====

fetch("graph.json")
  .then(res => res.json())
  .then(raw => {

    // Neo4j Browser export wrapper fix
    const data = raw[0].json.elements;

    const nodes = data.nodes.map(n => ({
      data: {
        id: n.data.id,
        label: n.data.labels[0],
        ...n.data
      }
    }));

    const edges = data.edges.map(e => ({
      data: {
        id: e.data.id,
        source: e.data.source,
        target: e.data.target,
        label: e.data.type,
        ...e.data
      }
    }));

    const allElements = [...nodes, ...edges];

    // ===== Initialize Cytoscape =====

    window.cy = cytoscape({
      container: document.getElementById("cy"),

      elements: allElements,

      style: [
        {
          selector: 'node',
          style: {
            'background-color': '#4da6ff',
            'label': 'data(label)',
            'font-size': 10,
            'text-valign': 'center',
            'color': '#222'
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 1.5,
            'line-color': '#bbb',
            'target-arrow-shape': 'triangle',
            'target-arrow-color': '#bbb',
            'curve-style': 'bezier'
          }
        }
      ],

      layout: { name: 'dagre' }
    });

    // ===== Initial landing filter =====

    resetView();

    // ===== Click handler =====

    cy.on('tap', 'node', function(evt) {
      const node = evt.target;
      const data = node.data();

      let html = `<b>Label:</b> ${data.label}<hr>`;

      Object.keys(data).forEach(k => {
        if (k !== "id" && k !== "label") {
          html += `
            <div class="prop">
              <div class="key">${k}</div>
              <div class="val">${data[k]}</div>
            </div>
          `;
        }
      });

      document.getElementById("details").innerHTML = html;

      // Expand neighbors visually
      node.closedNeighborhood().style('display', 'element');
    });

  });


// ===== UI FUNCTIONS =====

// Landing view: only main anchors

function resetView() {

  cy.elements().style('display', 'none');

  cy.nodes().filter(n =>
    n.data('label') === 'CircularValueChain' ||
    n.data('label') === 'Partner' ||
    n.data('label') === 'Deliverable'
  ).style('display', 'element');

  cy.layout({ name: 'dagre' }).run();
}

// Show everything

function showAll() {
  cy.elements().style('display', 'element');
  cy.layout({ name: 'cose' }).run();
}

</script>

</body>
</html>
