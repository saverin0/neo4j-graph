<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Graph Explorer</title>

<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

<style>
html,body {
  margin:0;
  height:100%;
  background:#070b18;
  font-family:Arial,Helvetica,sans-serif;
}

#topbar {
  position:fixed;
  top:12px;
  left:12px;
  right:12px;
  height:56px;
  display:flex;
  align-items:center;
  gap:10px;
  background:rgba(10,15,35,.85);
  backdrop-filter: blur(10px);
  border-radius:14px;
  padding:10px 14px;
  box-shadow:0 0 30px rgba(0,0,0,.7);
  z-index:10;
  color:#fff;
}

.btn {
  background:#141b3c;
  border:1px solid #2a3380;
  color:#fff;
  padding:7px 14px;
  border-radius:12px;
  cursor:pointer;
}
.btn:hover { background:#1c255c; }

#search {
  flex:1;
  background:#0f1433;
  border:1px solid #2a3380;
  border-radius:12px;
  padding:8px 12px;
  color:#fff;
}

#app {
  display:flex;
  height:100%;
}

#cy {
  flex:1;
}

#side {
  width:320px;
  padding:12px;
  background:#090f25;
  color:#eee;
  border-left:1px solid #1b2350;
}

.small { color:#aaa; font-size:12px; }
.k { color:#7fa3ff; font-size:12px; }
.v { margin-bottom:8px; }
.hidden { display:none; }

.legend {
  position:fixed;
  bottom:12px;
  left:12px;
  background:rgba(10,15,35,.9);
  padding:10px 14px;
  border-radius:12px;
  color:#ddd;
  font-size:13px;
}
.legend div { margin:4px 0; }
.dot { display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px; }

</style>
</head>

<body>

<div id="topbar">
  ⚡ <b>Graph Explorer</b>
  <button class="btn" onclick="homeView()">Home</button>
  <button class="btn" onclick="showAll()">Show all</button>
  <input id="search" placeholder="Search (any property) and press Enter">
  <span class="small">Hover = focus • Click = details • Double click = expand</span>
</div>

<div id="app">
  <div id="cy"></div>
  <div id="side">
    <h3>Details</h3>
    <div id="details" class="small">
      Clean landing view loaded.<br>
      Double click hubs to explore categories.
    </div>
  </div>
</div>

<div class="legend">
  <div><span class="dot" style="background:#00E5FF"></span> CircularValueChain</div>
  <div><span class="dot" style="background:#FF2BD6"></span> Partner</div>
  <div><span class="dot" style="background:#9BFF3A"></span> Deliverable</div>
  <div><span class="dot" style="background:#FFD34A"></span> Demonstration</div>
  <div><span class="dot" style="background:#FF7A00"></span> Innovation</div>
</div>

<script>

// COLORS
const COLORS = {
  hub:"#B8BFFF",
  CircularValueChain:"#00E5FF",
  Partner:"#FF2BD6",
  Deliverable:"#9BFF3A",
  Demonstration:"#FFD34A",
  Innovation:"#FF7A00",
  Other:"#8892ff"
};

// HUB DEFINITIONS
const HUBS = [
 {id:"HUB_CVC",label:"CircularValueChain",title:"Circular Value Chains"},
 {id:"HUB_PARTNER",label:"Partner",title:"Partners"},
 {id:"HUB_DELIV",label:"Deliverable",title:"Deliverables"},
 {id:"HUB_DEMO",label:"Demonstration",title:"Demonstrations"},
 {id:"HUB_INNO",label:"Innovation",title:"Innovations"}
];

let cy;

// TEXT CLEANER
function asNiceText(v){
 if(v===undefined||v===null) return "";
 if(Array.isArray(v)) return v.join(", ");
 return String(v);
}

// LABEL PICKER
function pickNodeLabel(d){
 const label=(d.labels&&d.labels[0])||"Other";

 if(label==="Partner") return asNiceText(d.partners)||asNiceText(d.partners_legalname)||d.id;
 if(label==="Deliverable") return asNiceText(d.deliverables_no)||asNiceText(d.deliverables_name)||d.id;
 if(label.toLowerCase().includes("circularvaluechain"))
   return asNiceText(d.valuechain_name)||asNiceText(d.value_chains)||d.id;
 if(label==="Demonstration") return asNiceText(d.demonstrations)||d.id;
 if(label==="Innovation") return asNiceText(d.innovations_name)||d.id;

 return asNiceText(d.phase_id)||d.id;
}

// HUB MAP
function hubIdFor(label){
 const L=(label||"").toLowerCase();
 if(L.includes("circularvaluechain")) return "HUB_CVC";
 if(L==="partner") return "HUB_PARTNER";
 if(L==="deliverable") return "HUB_DELIV";
 if(L==="demonstration") return "HUB_DEMO";
 if(L==="innovation") return "HUB_INNO";
 return null;
}

// LOAD GRAPH JSON
fetch("graph.json")
.then(r=>r.json())
.then(raw=>{

const elements=[];

// REAL NODES
raw[0].json.elements.nodes.forEach(n=>{
 elements.push({
   data:{
     id:n.data.id,
     label:n.data.labels[0],
     name:pickNodeLabel(n.data),
     raw:n.data,
     kind:"real"
   }
 });
});

// REAL EDGES
raw[0].json.elements.relationships.forEach(r=>{
 elements.push({
   data:{
     id:r.data.id,
     source:r.data.startNode,
     target:r.data.endNode,
     kind:"realEdge"
   }
 });
});

// HUB NODES
HUBS.forEach(h=>{
 elements.push({
   data:{
     id:h.id,
     name:h.title,
     label:h.label,
     kind:"hub"
   }
 });
});

// CYTOSCAPE INIT
cy=cytoscape({
 container:document.getElementById("cy"),
 elements,
 layout:{name:"preset"},
 style:[
 {
  selector:"node",
  style:{
    "background-color":ele=>COLORS[ele.data("label")]||COLORS.Other,
    "label":"data(name)",
    "color":"#fff",
    "font-size":"11px",
    "text-outline-color":"#000",
    "text-outline-width":2,
    "width":26,
    "height":26
  }
 },
 {
  selector:'node[kind="hub"]',
  style:{
    "width":85,
    "height":85,
    "font-size":"16px",
    "background-color":COLORS.hub,
    "font-weight":"bold"
  }
 },
 {
  selector:"edge",
  style:{
    "line-color":"#ccc",
    "target-arrow-color":"#ccc",
    "target-arrow-shape":"triangle",
    "width":1.5,
    "curve-style":"bezier"
  }
 },
 {
  selector:".hidden",
  style:{ "display":"none" }
 },
 {
  selector:".faded",
  style:{ "opacity":0.05 }
 }
 ]
});

homeView();

// ---------- INTERACTION ----------

// HOME VIEW
function homeView(){
 cy.elements().addClass("hidden");
 cy.nodes('[kind="hub"]').removeClass("hidden");

 const w=cy.width(),h=cy.height();

 cy.getElementById("HUB_CVC").position({x:w*0.45,y:h*0.55});
 cy.getElementById("HUB_PARTNER").position({x:w*0.30,y:h*0.35});
 cy.getElementById("HUB_DELIV").position({x:w*0.70,y:h*0.55});
 cy.getElementById("HUB_DEMO").position({x:w*0.55,y:h*0.30});
 cy.getElementById("HUB_INNO").position({x:w*0.55,y:h*0.75});

 cy.zoom(1);
 cy.center(cy.nodes('[kind="hub"]'));

 document.getElementById("details").innerHTML="Clean landing view loaded.";
}

// SHOW ALL
function showAll(){
 cy.elements().removeClass("hidden");
 cy.layout({name:"cose",animate:true,gravity:1}).run();
}

// REVEAL CATEGORY
function revealCategory(label){
 const hubId=hubIdFor(label);
 if(!hubId) return;

 cy.elements().addClass("hidden");
 cy.nodes('[kind="hub"]').removeClass("hidden");

 const hub=cy.getElementById(hubId);
 const center=hub.position();

 const group=cy.nodes().filter(n=>n.data("kind")==="real"&&n.data("label")===label);
 group.removeClass("hidden");

 cy.edges().addClass("hidden");

 const radius=220;
 const nodes=group.toArray();

 nodes.forEach((n,i)=>{
   const a=(2*Math.PI*i)/Math.max(nodes.length,1);
   n.position({
     x:center.x+radius*Math.cos(a),
     y:center.y+radius*Math.sin(a)
   });
 });

 cy.center(hub);
}

// CLICK → DETAILS
cy.on("tap","node",evt=>{
 const n=evt.target;
 if(n.data("kind")==="hub") return;

 const d=n.data("raw");
 let html=`<b>${n.data("name")}</b><br><br>`;

 Object.entries(d).forEach(([k,v])=>{
   html+=`<div class="k">${k}</div><div class="v">${asNiceText(v)}</div>`;
 });

 document.getElementById("details").innerHTML=html;
});

// DOUBLE CLICK → EXPAND
let lastTap=0;
cy.on("tap","node",evt=>{
 const now=Date.now();
 if(now-lastTap<250){
   const n=evt.target;
   if(n.data("kind")==="hub"){
     revealCategory(n.data("label"));
   } else {
     const neigh=n.closedNeighborhood();
     cy.elements().addClass("hidden");
     neigh.removeClass("hidden");
     cy.center(n);
   }
 }
 lastTap=now;
});

// HOVER FOCUS
cy.on("mouseover","node",evt=>{
 const n=evt.target;
 cy.elements().addClass("faded");
 n.closedNeighborhood().removeClass("faded");
});

cy.on("mouseout","node",()=>{
 cy.elements().removeClass("faded");
});

// SEARCH
document.getElementById("search").addEventListener("keydown",e=>{
 if(e.key==="Enter"){
   const q=e.target.value.toLowerCase();
   cy.elements().addClass("hidden");
   cy.nodes().filter(n=>{
     const raw=n.data("raw");
     return raw&&Object.values(raw).some(v=>String(v).toLowerCase().includes(q));
   }).removeClass("hidden");
 }
});

});
</script>
</body>
</html>
